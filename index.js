const table = `<table class="tg">
    <thead>
        <tr>
            <th class="tg-uzvj" colspan="10">NCSSM Weekly Timetable</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="tg-uzvj" colspan="2">MONDAY</td>
            <td class="tg-uzvj" colspan="2">TUESDAY</td>
            <td class="tg-uzvj" colspan="2">WEDNESDAY</td>
            <td class="tg-uzvj" colspan="2">THURSDAY</td>
            <td class="tg-uzvj" colspan="2">FRIDAY</td>
        </tr>
        <tr>
            <td class="tg-uzvj">08:30<br>to<br>09:20</td>
            <td class="tg-qzkb">{A1}</td>
            <td class="tg-7btt">08:30<br>to<br>09:20</td>
            <td class="tg-dfn3">{D2}</td>
            <td class="tg-7btt">08:30<br>to<br>09:20</td>
            <td class="tg-qzkb">{A3}</td>
            <td class="tg-7btt">08:30<br>to<br>09:20</td>
            <td class="tg-8cnv">{C4}</td>
            <td class="tg-7btt">08:30<br>to<br>09:20</td>
            <td class="tg-ix2u">{B5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">09:25<br>to<br>10:15</td>
            <td class="tg-ix2u">{B1}</td>
            <td class="tg-7btt">09:25<br>to<br>10:15</td>
            <td class="tg-ix2u">{B2}</td>
            <td class="tg-7btt">09:25<br>to<br>10:15</td>
            <td class="tg-dfn3">{D3}</td>
            <td class="tg-7btt">09:25<br>to<br>10:15</td>
            <td class="tg-qzkb">{A4}</td>
            <td class="tg-7btt">09:25<br>to<br>10:15</td>
            <td class="tg-8cnv">{C5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">10:20<br>to<br>11:10</td>
            <td class="tg-8cnv">{C1}</td>
            <td class="tg-7btt">10:20<br>to<br>11:10</td>
            <td class="tg-qzkb">{A2}</td>
            <td class="tg-7btt">10:20<br>to<br>11:10</td>
            <td class="tg-8cnv">{C3}</td>
            <td class="tg-7btt">10:20<br>to<br>11:10</td>
            <td class="tg-ix2u">{B4}</td>
            <td class="tg-7btt">10:20<br>to<br>11:10</td>
            <td class="tg-dfn3">{D5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">11:15<br>to<br>12:05</td>
            <td class="tg-dfn3">{D1}</td>
            <td class="tg-uzvj">11:10<br>to<br>11:50</td>
            <td class="tg-qzkb">{A2L}</td>
            <td class="tg-7btt">11:10<br>to<br>11:50</td>
            <td class="tg-8cnv">{C3L}</td>
            <td class="tg-7btt">11:10<br>to<br>11:50</td>
            <td class="tg-ix2u">{B4L}</td>
            <td class="tg-7btt">11:10<br>to<br>11:50</td>
            <td class="tg-dfn3">{D5L}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">12:05<br>to <br>12:55</td>
            <td class="tg-uzvj">LUNCH</td>
            <td class="tg-uzvj">11:50<br>to<br>12:40</td>
            <td class="tg-uzvj">LUNCH</td>
            <td class="tg-7btt">11:50<br>to<br>12:40</td>
            <td class="tg-uzvj">LUNCH</td>
            <td class="tg-7btt">11:50<br>to<br>12:40</td>
            <td class="tg-uzvj">LUNCH</td>
            <td class="tg-7btt">11:50<br>to<br>12:40</td>
            <td class="tg-uzvj">LUNCH</td>
        </tr>
        <tr>
            <td class="tg-uzvj">12:55<br>to<br>01:45</td>
            <td class="tg-h42r">{E1}</td>
            <td class="tg-uzvj">12:40<br>to<br>01:20</td>
            <td class="tg-h42r">{E2L}</td>
            <td class="tg-7btt">12:40<br>to<br>01:20</td>
            <td class="tg-70yv">{G3L}</td>
            <td class="tg-7btt">12:40<br>to<br>01:20</td>
            <td class="tg-fgpf">{F4L}</td>
            <td class="tg-7btt">12:40<br>to<br>01:20</td>
            <td class="tg-70yv">{G5L}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">01:50<br>to<br>02:40</td>
            <td class="tg-fgpf">{F1}</td>
            <td class="tg-uzvj">01:20<br>to<br>02:10</td>
            <td class="tg-h42r">{E2}</td>
            <td class="tg-7btt">01:20<br>to<br>02:10</td>
            <td class="tg-70yv">{G3}</td>
            <td class="tg-7btt">01:20<br>to<br>02:10</td>
            <td class="tg-fgpf">{F4}</td>
            <td class="tg-7btt">01:20<br>to<br>02:10</td>
            <td class="tg-70yv">{G5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">02:45<br>to<br>03:35</td>
            <td class="tg-70yv">{G1}</td>
            <td class="tg-uzvj" rowspan="2">02:10<br>to<br>04:00</td>
            <td class="tg-efol" rowspan="2">Flexible Use Time</td>
            <td class="tg-uzvj">02:15<br>to<br>03:05</td>
            <td class="tg-fgpf">{F3}</td>
            <td class="tg-uzvj" rowspan="2">02:10<br>to<br>04:00</td>
            <td class="tg-efol" rowspan="2">Flexible Use Time</td>
            <td class="tg-uzvj">02:15 <br>to<br>03:05</td>
            <td class="tg-fgpf">{F5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">03:35<br>to<br>04:25</td>
            <td class="tg-efol">Meeting</td>
            <td class="tg-uzvj">03:10 <br>to<br>04:00</td>
            <td class="tg-h42r">{E3}</td>
            <td class="tg-7btt">03:10 <br>to<br>04:00</td>
            <td class="tg-h42r">{E5}</td>
        </tr>
        <tr>
            <td class="tg-uzvj" colspan="2">Monday</td>
            <td class="tg-uzvj" colspan="2">Tuesday</td>
            <td class="tg-uzvj" colspan="2">Wednesday</td>
            <td class="tg-uzvj" colspan="2">Thursday</td>
            <td class="tg-efol" colspan="2" rowspan="3">Evening</td>
        </tr>
        <tr>
            <td class="tg-uzvj">06:15<br>to<br>07:55</td>
            <td class="tg-noe9">{H1}</td>
            <td class="tg-uzvj">06:15<br>to<br>07:55</td>
            <td class="tg-noe9">{H2}</td>
            <td class="tg-7btt">06:15<br>to<br>07:55</td>
            <td class="tg-noe9">{H3}</td>
            <td class="tg-7btt">06:15<br>to<br>07:55</td>
            <td class="tg-noe9">{H4}</td>
        </tr>
        <tr>
            <td class="tg-uzvj">08:05<br>to<br>9:45</td>
            <td class="tg-29js">{I1}</td>
            <td class="tg-uzvj">08:05<br>to<br>9:45</td>
            <td class="tg-29js">{I2}</td>
            <td class="tg-7btt">08:05<br>to<br>9:45</td>
            <td class="tg-29js">{I3}</td>
            <td class="tg-7btt">08:05<br>to<br>9:45</td>
            <td class="tg-29js">{I4}</td>
        </tr>
    </tbody>
</table>`;

let isEqual = (a, b) => {
    if (a === b) {
        return true;
    }
    if ((a instanceof Set) && (b instanceof Set)) {
        return a.size === b.size && [...a].every(value => b.has(value));
    }
    return false;
}

class Class {
    constructor(class_name, class_code) {
        this.class_code = class_code;
        this.class_name = class_name;
        this.class_rating = null;
        this.class_summary = null;
        this.field = null;
        this.offered = null;
        this.sem1ResMeet = [];
        this.sem2ResMeet = [];
    }
}

let classes = [];
let sem1Classes = [];
const sem1ClassDiv = document.getElementById('sem1-class-list_');
let sem2Classes = [];
let sem1Validity = checkValidity(sem1Classes, 1);
let sem2Validity = checkValidity(sem2Classes, 2);
const sem2ClassDiv = document.getElementById('sem2-class-list_');
const scheduleSem1 = document.getElementById('schedule-possibilities1');
const scheduleSem2 = document.getElementById('schedule-possibilities2');
const calendarSem1 = document.getElementById('calendarSem1');
const calendarSem2 = document.getElementById('calendarSem2');
const scheduleTags = document.querySelectorAll(".scheduleTag");

const full = `\u{25CF}`, half = `\u{25D6}`;

const classSelector = document.getElementById('class-selector');
const classOptions = document.getElementById("class-options");
const semSetting = document.getElementById("set-semester");
const searchBar = document.getElementById("class-searchbox");
const fieldOptions = document.getElementById("field-select");
const menu = document.getElementById("title-bar");

let schedCount1 = 0, schedCount2 = 0;
// const url = 'https://uniapp.ncssm.edu/registrar/catalog/course_catalog_beta1.3.1.php';

let sem1ResMeetData, sem2ResMeetData;
const sem1Res = 'https://docs.google.com/spreadsheets/d/1UDDykgtiBTb3f5saTyFb8q3fL1sWuDLgwJEkZJ6ym6o/edit#gid=0';
const sem2Res = 'https://docs.google.com/spreadsheets/d/1UDDykgtiBTb3f5saTyFb8q3fL1sWuDLgwJEkZJ6ym6o/edit#gid=934085507';

const schedule = {
    A1: null,
    A2: null,
    A3: null,
    A4: null,
    B1: null,
    B2: null,
    B4: null,
    B5: null,
    C1: null,
    C3: null,
    C4: null,
    C5: null,
    D1: null,
    D2: null,
    D3: null,
    D5: null,
    A2L: null,
    C3L: null,
    B4L: null,
    D5L: null,
    E1: null,
    E2: null,
    E3: null,
    E5: null,
    F1: null,
    F3: null,
    F4: null,
    F5: null,
    G1: null,
    G3: null,
    G5: null,
    E2L: null,
    G3L: null,
    F4L: null,
    G5L: null,
    H1: null,
    H2: null,
    H3: null,
    H4: null,
    I1: null,
    I2: null,
    I3: null,
    I4: null
}

sheetrock({
    url: sem1Res,
    callback: (error, options, response) => {
        sem1ResMeetData = response.rows.slice(1);
        checkAllMeetingSheetsLoaded();
    }
});

sheetrock({
    url: sem2Res,
    callback: (error, options, response) => {
        sem2ResMeetData = response.rows.slice(1);
        checkAllMeetingSheetsLoaded();
    }
});

let uniq = a => [...new Set(a)];

let count = 0;
function checkAllMeetingSheetsLoaded() {
    count++;
    if (count == 2) {
        // When both meeting patterns are loaded, then the course catalog is loaded.
        // performFetch();
        generateClasses();
    }
}

function generateClasses() {
    semSetting.checked = false
    // Unhide the actual content when everything is loaded
    document.getElementById('loading-panel').classList.add('opacity-0');
    setTimeout(() => { document.getElementById('loading-panel').hidden = true; }, 1000);

    // Iterate over every class in the catalog
    for (let clss of sem1ResMeetData.concat(sem2ResMeetData)) {
        let clsname = clss.cellsArray[0];
        let code = clsname.split(" ", 1)[0].trim();
        if (code.includes("/")) {
            code = new Set(code.split("/"));
        }

        let field = (code instanceof Set) ? [...code].map((v) => v.replaceAll(/\d/g, "")) : code.replace(/\d/g, "");
        clsname = clsname.split(" ").slice(1).join(" ");
        clsname = clsname.replaceAll(code, "");
        cls = new Class(clsname.trim(), code);
        cls.field = (field instanceof Array) ? field.map(v => v.replaceAll("_", " ")) : field.replaceAll("_", " ");
        match_ = false;

        // Check if class is already in system
        for (const cls_ of classes) {
            if (isEqual(cls_.class_code, cls.class_code) && cls_.class_name === cls.class_name) {
                match_ = true;
                break
            }
        }

        if (!match_) classes.push(cls);

        let relRows = sem1ResMeetData.filter(value => {
            let match = value.cellsArray[0].includes(code);
            if (code instanceof Set) {
                code.forEach((val) => {
                    match |= value.cellsArray[0].includes(val);
                }); // Are any of the classes the same?
            }

            // Assume classes are residental
            return match
        });

        relRows = relRows.map(value => {
            return value.cellsArray[2];
        });

        // Sometimes class meeting times are listed multiple times
        cls.sem1ResMeet = uniq(relRows); // Minimize combinations to check

        relRows = sem2ResMeetData.filter(value => {
            let match = value.cellsArray[0].includes(code);
            if (code instanceof Set) {
                code.forEach((val) => {
                    match |= value.cellsArray[0].includes(val);
                });
            }
            return match
        });
        relRows = relRows.map(value => {
            return value.cellsArray[2];
        });
        cls.sem2ResMeet = uniq(relRows);
    }
    setOptions(classes);
    populateFields(classes);
    displaySchedules();
}

// function performFetch() {
//     fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`)
//         .then(response => {
//             if (response.ok) return response.json()
//             throw new Error('Network response was not ok.')
//         })
//         .then(data => {
//             // Unhide the actual content when everything is loaded
//             document.getElementById('loading-panel').classList.add('opacity-0');
//             setTimeout(() => { document.getElementById('loading-panel').hidden = true; }, 1000);

//             let doc = document.createElement('html');
//             doc.innerHTML = data.contents; // Copy the HTML of the catalog over here

//             let clss = doc.getElementsByClassName("results_list");

//             // Iterate over every class in the catalog
//             for (let index = 0; index < clss.length; index++) {
//                 let cls = clss[index];
//                 let clsname = cls.innerText;
//                 let code = clsname.split(" ", 1)[0].trim();
//                 if (code.includes("/")) {
//                     code = new Set(code.split("/"));
//                 }
//                 let class_summary = cls.dataset.description;
//                 let field = cls.classList[5];
//                 let offered = cls.className;
//                 clsname = clsname.split(" ").slice(1).join(" ");
//                 clsname = clsname.replaceAll(code, "");
//                 cls = new Class(clsname.trim(), code);
//                 cls.class_rating = 0;
//                 cls.class_summary = class_summary;
//                 cls.field = field.replaceAll("_", " ");
//                 cls.offered = offered;
//                 match_ = false;

//                 // Check if class is already in system
//                 for (const cls_ of classes) {
//                     if (isEqual(cls_.class_code, cls.class_code) && cls_.class_name === cls.class_name) {
//                         match_ = true;
//                         break
//                     }
//                 }

//                 if (!match_) classes.push(cls);

//                 let relRows = sem1ResMeetData.filter(value => {
//                     let match = value.cellsArray[0].includes(code);
//                     if (code instanceof Set) {
//                         code.forEach((val) => {
//                             match |= value.cellsArray[0].includes(val);
//                         }); // Are any of the classes the same?
//                     }

//                     // Assume class is residential
//                     return match
//                 });

//                 relRows = relRows.map(value => {
//                     return value.cellsArray[2];
//                 });

//                 // Sometimes class meeting times are listed multiple times
//                 cls.sem1ResMeet = uniq(relRows); // Minimize combinations to check

//                 relRows = sem2ResMeetData.filter(value => {
//                     let match = value.cellsArray[0].includes(code);
//                     if (code instanceof Set) {
//                         code.forEach((val) => {
//                             match |= value.cellsArray[0].includes(val);
//                         });
//                     }
//                     return match
//                 });
//                 relRows = relRows.map(value => {
//                     return value.cellsArray[2];
//                 });
//                 cls.sem2ResMeet = uniq(relRows);
//             }
//             setOptions(classes);
//             populateFields(classes);
//         });
// }

function populateFields(classList) {
    fields = new Set([" - No Selection - "]);
    classList.forEach(element => {
        (element.field instanceof Array) ? element.field.forEach(fields.add, fields) : fields.add(element.field);
    });
    fields.forEach(element => {
        let option = new Option();
        option.innerHTML = element;
        option.value = element.replaceAll(" ", "_");
        fieldOptions.appendChild(option);
    });
}

fieldOptions.addEventListener("change", (ev) => {
    setOptions(classes);
});

semSetting.addEventListener("change", (ev) => {
    if (semSetting.checked) {
        document.getElementById("semester-setting").innerHTML = "Semester 2";
        sem1ClassDiv.parentElement.classList.remove("show");
        scheduleSem1.classList.remove("show", "active");
        sem2ClassDiv.parentElement.classList.add("show");
        scheduleSem2.classList.add("show");
    } else {
        document.getElementById("semester-setting").innerHTML = "Semester 1";
        sem2ClassDiv.parentElement.classList.remove("show");
        scheduleSem2.classList.remove("show", "active");
        sem1ClassDiv.parentElement.classList.add("show");
        scheduleSem1.classList.add("show");
    }
    setOptions(classes);
});

scheduleTags.forEach((element) => {
    element.addEventListener('click', () => {
        element.parentElement.classList.toggle("active");
    });
});

searchBar.addEventListener("input", (ev) => {
    setOptions(classes);
});

function setOptions(classList) {
    classOptions.innerHTML = "";
    if (fieldOptions.value.trim() == '_-_No_Selection_-_' || fieldOptions.value.trim() == "") {
        classList = classList;
    } else {
        classList = classes.filter(value => {
            if (value.field instanceof Array) {
                return value.field.includes(fieldOptions.value.replaceAll("_", " "));
            } else {
                return value.field == fieldOptions.value.replaceAll("_", " ");
            }
        });
    }
    let lower = searchBar.value.toLowerCase();
    classList = classList.filter(value => {
        if (value.class_code instanceof Set) {
            let match = false;
            value.class_code.forEach(elem => {
                match |= elem.toLowerCase().includes(lower);
            });
            return match || value.class_name.toLowerCase().includes(lower);
        }
        return value.class_code.toLowerCase().includes(lower) || value.class_name.toLowerCase().includes(lower);
    })

    if (semSetting.checked) {
        classList = classList.filter(value => {
            return !sem2Classes.includes(value) && value.sem2ResMeet.length > 0;
        });
    } else {
        classList = classList.filter(value => {
            return !sem1Classes.includes(value) && value.sem1ResMeet.length > 0;
        });
    }

    classList.forEach(element => {
        let node = document.createElement('div');
        node.classList.add('class-block');
        node.classList.add('text-center');
        node.classList.add('p-2');
        node.classList.add('w-full');
        node.innerHTML = `<b>${element.class_code}</b> ${element.class_name}`;
        if (element.class_code instanceof Set) {
            let code = '';
            element.class_code.forEach(value => {
                code += value;
                code += '/';
            });
            code = code.slice(0, -1);
            node.innerHTML = `<b>${code}</b> ${element.class_name}`;
        }
        let rating = Math.round(element.class_rating * 2);
        // node.title = `Rating: ${full.repeat(Math.floor(rating / 2)) + half.repeat(rating % 2)} (${element.class_rating.toPrecision(2)})\n${element.class_summary}`;
        node.setAttribute("data-toggle", "tooltip");
        let wrapNode = document.createElement('div');
        wrapNode.append(document.createElement('hr'), node, document.createElement('hr'));
        classOptions.append(wrapNode);
        node.addEventListener('click', (ev) => {
            if (semSetting.checked) {
                sem2Classes.push(element);
            } else {
                sem1Classes.push(element);
            }
            updateSemesterClasses();
            setOptions(classes);
        });
    });
}

window.onload = () => {
    setTimeout(() => { document.getElementsByTagName("header")[0].classList.add("hide"); }, 300);
    setTimeout(() => { document.getElementById("class-selector").classList.add("hide"); }, 800);
    setOptions(classes);
};

function updateSemesterClasses() {
    sem1ClassDiv.innerHTML = "";
    sem2ClassDiv.innerHTML = "";

    sem1Classes.forEach(element => {
        let node = document.createElement('div');
        node.classList.add('class-block');
        node.classList.add('text-center');
        node.classList.add('p-2');
        node.classList.add('w-full');
        node.innerHTML = `<b>${element.class_code}</b> ${element.class_name}`;
        if (element.class_code instanceof Set) {
            let code = '';
            element.class_code.forEach(value => {
                code += value;
                code += '/';
            });
            code = code.slice(0, -1);
            node.innerHTML = `<b>${code}</b> ${element.class_name}`;
        }
        let rating = Math.round(element.class_rating * 2);
        // node.title = `Rating: ${full.repeat(Math.floor(rating / 2)) + half.repeat(rating % 2)} (${element.class_rating.toPrecision(2)})\n${element.class_summary}`;
        node.setAttribute("data-toggle", "tooltip");
        let wrapNode = document.createElement('div');
        wrapNode.append(document.createElement('hr'), node, document.createElement('hr'));
        sem1ClassDiv.append(wrapNode);
        node.addEventListener('click', (ev) => {
            sem1Classes.splice(Array.prototype.indexOf.call(sem1ClassDiv.children, node.parentElement), 1);
            updateSemesterClasses();
            setOptions(classes);
        });
    });

    sem2Classes.forEach(element => {
        let node = document.createElement('div');
        node.classList.add('class-block');
        node.classList.add('text-center');
        node.classList.add('p-2');
        node.classList.add('w-full');
        node.innerHTML = `<b>${element.class_code}</b> ${element.class_name}`;
        if (element.class_code instanceof Set) {
            let code = '';
            element.class_code.forEach(value => {
                code += value;
                code += '/';
            });
            code = code.slice(0, -1);
            node.innerHTML = `<b>${code}</b> ${element.class_name}`;
        }
        let rating = Math.round(element.class_rating * 2);
        // node.title = `Rating: ${full.repeat(Math.floor(rating / 2)) + half.repeat(rating % 2)} (${element.class_rating.toPrecision(2)})\n${element.class_summary}`;
        node.setAttribute("data-toggle", "tooltip");
        let wrapNode = document.createElement('div');
        wrapNode.append(document.createElement('hr'), node, document.createElement('hr'));
        sem2ClassDiv.append(wrapNode);
        node.addEventListener('click', (ev) => {
            sem2Classes.splice(Array.prototype.indexOf.call(sem2ClassDiv.children, node.parentElement), 1);
            updateSemesterClasses();
        });
    });

    sem1Validity = checkValidity(sem1Classes, 1);
    sem2Validity = checkValidity(sem2Classes, 2);

    if (sem1Validity.classConflicts.size > 0) {
        sem1Validity.classConflicts.forEach((v) => {
            c = v.split(" ");
            c = [parseInt(c[0]), parseInt(c[1])];
            sem1ClassDiv.children[c[0]].classList.add("bg-red-400");
            sem1ClassDiv.children[c[1]].classList.add("bg-red-400");
        })
    }

    if (sem2Validity.classConflicts.size > 0) {
        sem2Validity.classConflicts.forEach((v) => {
            c = v.split(" ");
            c = [parseInt(c[0]), parseInt(c[1])];
            sem2ClassDiv.children[c[0]].classList.add("bg-red-400");
            sem2ClassDiv.children[c[1]].classList.add("bg-red-400");
        })
    }

    if (sem1Validity.success) {
        document.querySelectorAll(".scheduleTag")[0].innerHTML = `Schedule ${schedCount1 + 1}/${sem1Validity.schedules.length}`;
        document.querySelector(".sem1.header").classList.remove("bg-yellow-200", "bg-red-200");
        document.querySelector(".sem1.header").classList.add("bg-green-200");
    }
    else {
        document.querySelectorAll(".scheduleTag")[0].innerHTML = `Schedule`;
        document.querySelector(".sem1.header").classList.remove("bg-yellow-200", "bg-green-200");
        document.querySelector(".sem1.header").classList.add("bg-red-200");
    }

    if (sem2Validity.success) {
        document.querySelectorAll(".scheduleTag")[1].innerHTML = `Schedule ${schedCount2 + 1}/${sem2Validity.schedules.length}`;
        document.querySelector(".sem2.header").classList.remove("bg-yellow-200", "bg-red-200");
        document.querySelector(".sem2.header").classList.add("bg-green-200");
    }
    else {
        document.querySelectorAll(".scheduleTag")[1].innerHTML = `Schedule`;
        document.querySelector(".sem2.header").classList.remove("bg-yellow-200", "bg-green-200");
        document.querySelector(".sem2.header").classList.add("bg-red-200");
    }

    displaySchedules();
}

menu.addEventListener('click', (ev) => {
    menu.children[0].classList.toggle('active');
    menu.children[1].classList.toggle('active');
    menu.children[2].classList.toggle('active');
    classSelector.classList.toggle('show');
});

// Input: str[][] (eg., [['A12L3', 'C13L5'], ['G13L5', 'F134L5']])
function generatePermutations(meetings) {
    meetings = meetings.map(a => a.map(b => [b]));
    if (meetings.length === 0) return;
    if (meetings.length == 1) return meetings[0];
    let comb = (a, b) => {
        let combos = [];
        a.forEach((c) => {
            b.forEach((d) => {
                combos.push(c.concat(d));
            })
        })
        return combos;
    };
    let prep = comb(meetings[0], meetings[1]);
    for (let index = 2; index < meetings.length; index++) {
        prep = comb(prep, meetings[index]);
    }
    return prep;
}

function decomp(meeting) {
    if (meeting[0] == "M") return [];
    let blockLetter;
    let blocks = [];

    [...meeting].forEach((val, index) => {
        if (isNaN(val) && val != "L") blockLetter = val;
        else {
            if (val == "L") blocks.push(blockLetter + meeting[index - 1] + "L");
            else blocks.push(blockLetter + val);
        }
    });
    return blocks;
}

function checkValidity(classList, sem) {
    if (classList.length === 0) return { success: false, classConflicts: [], schedules: [] };
    let scheds = [];
    let conflicts = [];
    generatePermutations(classList.map((v) => { return v[`sem${sem}ResMeet`]; })).forEach((v) => {
        let blocks = v.map(decomp);
        let sched = { ...schedule };

        let success = true;
        let conflict = new Set();

        blocks.forEach((v_, idx) => {
            v_.forEach((v__) => {
                if (sched[v__] === null) sched[v__] = idx;
                else {
                    success = false;
                    conflict.add(`${sched[v__]} ${idx}`);
                }
            })
        })

        if (success) scheds.push(sched);
        conflicts.push(conflict);
    });
    return {
        success: scheds.length > 0,
        classConflicts: scheds.length == 0 ? conflicts.reduce((a, b) => a.size < b.size ? a : b) : new Set(),
        schedules: scheds
    };
}

function displaySchedules() {
    if (sem1Validity.success) {
        let replTable = table;
        schedCount1 = sem1Validity.schedules.length > 0 ? schedCount1 % sem1Validity.schedules.length : 0;
        Object.keys(schedule).forEach(v => {
            let idx = sem1Validity.schedules[schedCount1 % sem1Validity.schedules.length][v];
            idx = idx == NaN ? 0 : idx;
            if (idx != null) {
                let code = sem1Classes[idx].class_code;
                replTable = replTable.replace(`{${v}}`,
                    (code instanceof Set) ? [...code].join("/") : code)
            } else {
                replTable = replTable.replace(`{${v}}`,
                    "");
            }
        });
        document.querySelector("#cal1wrap").innerHTML = replTable;
    } else {
        document.querySelector("#cal1wrap").innerHTML = table;
    }

    if (sem2Validity.success) {
        let replTable = table;
        schedCount2 = sem2Validity.schedules.length > 0 ? schedCount2 % sem2Validity.schedules.length : 0;
        Object.keys(schedule).forEach(v => {
            let idx = sem2Validity.schedules[schedCount2 % sem2Validity.schedules.length][v];
            idx = idx == NaN ? 0 : idx;
            if (idx != null) {
                let code = sem2Classes[idx].class_code;
                replTable = replTable.replace(`{${v}}`,
                    (code instanceof Set) ? [...code].join("/") : code)
            } else {
                replTable = replTable.replace(`{${v}}`,
                    "")
            }
        });
        document.querySelector("#cal2wrap").innerHTML = replTable;
    } else {
        document.querySelector("#cal2wrap").innerHTML = table;
    }
}

document.querySelector("#calendarSem1").addEventListener("click", e => {
    let cal = document.querySelector("#cal1wrap");
    console.log(e.clientX < cal.offsetLeft + cal.offsetWidth / 2.0, e.clientX, cal.offsetLeft + cal.offsetWidth / 2.0);
    if (e.clientX < cal.offsetLeft + cal.offsetWidth / 2.0) {
        schedCount1 = (schedCount1 - 1 < 0) ? schedCount1 - 1 + sem1Validity.schedules.length : schedCount1 - 1;
    }
    else {
        schedCount1 = (schedCount1 + 1) % sem1Validity.schedules.length;
    }

    displaySchedules();

    if (sem1Validity.success) {
        document.querySelectorAll(".scheduleTag")[0].innerHTML = `Schedule ${schedCount1 + 1}/${sem1Validity.schedules.length}`;
        document.querySelector(".sem1.header").classList.remove("bg-yellow-200", "bg-red-200");
        document.querySelector(".sem1.header").classList.add("bg-green-200");
    }
    else {
        document.querySelectorAll(".scheduleTag")[0].innerHTML = `Schedule`;
        document.querySelector(".sem1.header").classList.remove("bg-yellow-200", "bg-green-200");
        document.querySelector(".sem1.header").classList.add("bg-red-200");
    }
})

document.querySelector("#calendarSem2").addEventListener("click", e => {
    let cal = document.querySelector("#cal2wrap");
    console.log(e.clientX < cal.offsetLeft + cal.offsetWidth / 2.0, e.clientX, cal.offsetLeft + cal.offsetWidth / 2.0);
    if (e.clientX < cal.offsetLeft + cal.offsetWidth / 2.0) {
        schedCount2 = (schedCount2 - 1 < 0) ? schedCount2 - 1 + sem2Validity.schedules.length : schedCount2 - 1;
    }
    else {
        schedCount2 = (schedCount2 + 1) % sem2Validity.schedules.length;
    }

    displaySchedules();

    if (sem2Validity.success) {
        document.querySelectorAll(".scheduleTag")[1].innerHTML = `Schedule ${schedCount2 + 1}/${sem2Validity.schedules.length}`;
        document.querySelector(".sem2.header").classList.remove("bg-yellow-200", "bg-red-200");
        document.querySelector(".sem2.header").classList.add("bg-green-200");
    }
    else {
        document.querySelectorAll(".scheduleTag")[1].innerHTML = `Schedule`;
        document.querySelector(".sem2.header").classList.remove("bg-yellow-200", "bg-green-200");
        document.querySelector(".sem2.header").classList.add("bg-red-200");
    }
})